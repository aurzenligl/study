import os
import timeit
import melina

datadir = os.path.abspath(__file__ + '/../data')

def tokens(filename, tuples = False):
    ts = melina.Tokenizer.from_file(datadir + '/' + filename)
    tokens = []
    while True:
        tok = ts.get()
        tokens.append(tuples and tok2tuple(tok) or tok)
        if tok.kind == tok.kind.END:
            return tokens

def tok2tuple(tok):
    return (
        tok.span and str(tok.span),
        tok.kind.name,
        tok.value
    )

class TestTokenizer():
    def test_configure(self):
        toks = tokens('configure.meta', tuples=True)
        assert toks == [
            ('1:1-1:2', 'KEYW', 'mo'),
            ('1:4-1:27', 'NAME', 'CONFIGURE_MECHANISM_TASK'),
            ('1:29-1:30', 'ARROW', None),
            ('1:32-1:37', 'NAME', 'RESULT'),
            ('2:1-2:1', 'LCB', None),
            ('3:5-3:10', 'KEYW', 'struct'),
            ('3:12-3:21', 'NAME', 'alphaDelta'),
            ('4:5-4:5', 'LCB', None),
            ('5:9-5:16', 'KEYW', 'repeated'),
            ('5:18-5:23', 'KEYW', 'struct'),
            ('5:25-5:32', 'NAME', 'modified'),
            ('6:9-6:9', 'LCB', None),
            ('7:13-7:18', 'KEYW', 'string'),
            ('7:20-7:21', 'NAME', 'dn'),
            ('7:22-7:22', 'SEMI', None),
            ('8:13-8:15', 'KEYW', 'int'),
            ('8:17-8:21', 'NAME', 'param'),
            ('8:22-8:22', 'SEMI', None),
            ('9:9-9:9', 'RCB', None),
            ('9:10-9:10', 'SEMI', None),
            ('10:5-10:5', 'RCB', None),
            ('10:6-10:6', 'SEMI', None),
            ('12:5-12:10', 'KEYW', 'struct'),
            ('12:12-12:20', 'NAME', 'betaDelta'),
            ('13:5-13:5', 'LCB', None),
            ('14:9-14:16', 'KEYW', 'repeated'),
            ('14:18-14:23', 'KEYW', 'struct'),
            ('14:25-14:29', 'NAME', 'added'),
            ('15:9-15:9', 'LCB', None),
            ('16:13-16:18', 'KEYW', 'string'),
            ('16:20-16:24', 'NAME', 'devDn'),
            ('16:25-16:25', 'SEMI', None),
            ('17:13-17:15', 'KEYW', 'int'),
            ('17:17-17:18', 'NAME', 'id'),
            ('17:19-17:19', 'SEMI', None),
            ('18:13-18:15', 'KEYW', 'int'),
            ('18:17-18:21', 'NAME', 'param'),
            ('18:22-18:22', 'SEMI', None),
            ('19:9-19:9', 'RCB', None),
            ('19:10-19:10', 'SEMI', None),
            ('20:9-20:16', 'KEYW', 'repeated'),
            ('20:18-20:23', 'KEYW', 'struct'),
            ('20:25-20:32', 'NAME', 'modified'),
            ('21:9-21:9', 'LCB', None),
            ('22:13-22:18', 'KEYW', 'string'),
            ('22:20-22:21', 'NAME', 'dn'),
            ('22:22-22:22', 'SEMI', None),
            ('23:13-23:15', 'KEYW', 'int'),
            ('23:17-23:21', 'NAME', 'param'),
            ('23:22-23:22', 'SEMI', None),
            ('24:9-24:9', 'RCB', None),
            ('24:10-24:10', 'SEMI', None),
            ('25:9-25:16', 'KEYW', 'repeated'),
            ('25:18-25:23', 'KEYW', 'struct'),
            ('25:25-25:31', 'NAME', 'removed'),
            ('26:9-26:9', 'LCB', None),
            ('27:13-27:18', 'KEYW', 'string'),
            ('27:20-27:21', 'NAME', 'dn'),
            ('27:22-27:22', 'SEMI', None),
            ('28:9-28:9', 'RCB', None),
            ('28:10-28:10', 'SEMI', None),
            ('29:5-29:5', 'RCB', None),
            ('29:6-29:6', 'SEMI', None),
            ('36:5-36:10', 'KEYW', 'struct'),
            ('36:12-36:21', 'NAME', 'gammaDelta'),
            ('37:5-37:5', 'LCB', None),
            ('38:9-38:16', 'KEYW', 'repeated'),
            ('38:18-38:23', 'KEYW', 'struct'),
            ('38:25-38:32', 'NAME', 'modified'),
            ('39:9-39:9', 'LCB', None),
            ('40:13-40:18', 'KEYW', 'string'),
            ('40:20-40:21', 'NAME', 'dn'),
            ('40:22-40:22', 'SEMI', None),
            ('41:13-41:20', 'KEYW', 'optional'),
            ('41:22-41:27', 'KEYW', 'struct'),
            ('41:29-41:34', 'NAME', 'config'),
            ('42:13-42:13', 'LCB', None),
            ('43:17-43:24', 'KEYW', 'optional'),
            ('43:26-43:28', 'KEYW', 'int'),
            ('43:30-43:34', 'NAME', 'param'),
            ('43:35-43:35', 'SEMI', None),
            ('44:17-44:24', 'KEYW', 'optional'),
            ('44:26-44:31', 'KEYW', 'struct'),
            ('44:33-44:43', 'NAME', 'gammaConfig'),
            ('45:17-45:17', 'LCB', None),
            ('46:21-46:24', 'KEYW', 'enum'),
            ('46:26-46:33', 'NAME', 'attitude'),
            ('47:21-47:21', 'LCB', None),
            ('48:25-48:32', 'NAME', 'Disabled'),
            ('48:34-48:34', 'ASSIGN', None),
            ('48:36-48:36', 'NUMBER', 0),
            ('48:37-48:37', 'COMMA', None),
            ('49:25-49:31', 'NAME', 'Enabled'),
            ('49:33-49:33', 'ASSIGN', None),
            ('49:35-49:35', 'NUMBER', 1),
            ('50:21-50:21', 'RCB', None),
            ('50:22-50:22', 'SEMI', None),
            ('51:17-51:17', 'RCB', None),
            ('51:18-51:18', 'SEMI', None),
            ('52:17-52:24', 'KEYW', 'repeated'),
            ('52:26-52:31', 'KEYW', 'struct'),
            ('52:33-52:50', 'NAME', 'gammaGimmickConfig'),
            ('53:17-53:17', 'LCB', None),
            ('54:21-54:26', 'KEYW', 'string'),
            ('54:28-54:29', 'NAME', 'dn'),
            ('54:30-54:30', 'SEMI', None),
            ('55:21-55:23', 'KEYW', 'int'),
            ('55:25-55:28', 'NAME', 'rate'),
            ('55:29-55:29', 'SEMI', None),
            ('56:21-56:23', 'KEYW', 'int'),
            ('56:25-56:28', 'NAME', 'size'),
            ('56:29-56:29', 'SEMI', None),
            ('57:17-57:17', 'RCB', None),
            ('57:18-57:18', 'SEMI', None),
            ('58:13-58:13', 'RCB', None),
            ('58:14-58:14', 'SEMI', None),
            ('59:9-59:9', 'RCB', None),
            ('59:10-59:10', 'SEMI', None),
            ('60:5-60:5', 'RCB', None),
            ('60:6-60:6', 'SEMI', None),
            ('61:1-61:1', 'RCB', None),
            ('61:2-61:2', 'SEMI', None),
            (None, 'END', None),
        ]

    def test_example(self):
        toks = tokens('example.meta', tuples=True)
        assert toks == [
            ('1:1-1:2', 'KEYW', 'mo'),
            ('1:4-1:12', 'NAME', 'MACHINE_L'),
            ('1:14-1:15', 'ARROW', None),
            ('1:17-1:22', 'NAME', 'SENSOR'),
            ('1:23-1:23', 'COMMA', None),
            ('1:25-1:29', 'NAME', 'WHEEL'),
            ('1:30-1:30', 'COMMA', None),
            ('1:32-1:34', 'NAME', 'ARM'),
            ('2:1-2:1', 'LCB', None),
            ('3:5-3:10', 'KEYW', 'struct'),
            ('3:12-3:19', 'NAME', 'StateBox'),
            ('4:5-4:5', 'LCB', None),
            ('5:9-5:16', 'KEYW', 'repeated'),
            ('5:18-5:21', 'KEYW', 'enum'),
            ('5:23-5:33', 'NAME', 'FaultStatus'),
            ('5:35-5:35', 'LCB', None),
            ('5:37-5:41', 'NAME', 'Empty'),
            ('5:42-5:42', 'COMMA', None),
            ('5:44-5:55', 'NAME', 'Disconnected'),
            ('5:56-5:56', 'COMMA', None),
            ('5:58-5:68', 'NAME', 'RoofFlewOff'),
            ('5:70-5:70', 'RCB', None),
            ('5:71-5:71', 'SEMI', None),
            ('6:9-6:12', 'KEYW', 'enum'),
            ('6:14-6:24', 'NAME', 'AdminStatus'),
            ('6:26-6:26', 'LCB', None),
            ('6:28-6:33', 'NAME', 'Locked'),
            ('6:34-6:34', 'COMMA', None),
            ('6:36-6:43', 'NAME', 'Unlocked'),
            ('6:45-6:45', 'RCB', None),
            ('6:46-6:46', 'SEMI', None),
            ('7:9-7:12', 'KEYW', 'enum'),
            ('7:14-7:24', 'NAME', 'AvailStatus'),
            ('7:26-7:26', 'LCB', None),
            ('7:28-7:33', 'NAME', 'Online'),
            ('7:34-7:34', 'COMMA', None),
            ('7:36-7:42', 'NAME', 'Offline'),
            ('7:44-7:44', 'RCB', None),
            ('7:45-7:45', 'SEMI', None),
            ('8:5-8:5', 'RCB', None),
            ('8:6-8:6', 'SEMI', None),
            ('10:5-10:12', 'KEYW', 'optional'),
            ('10:14-10:19', 'KEYW', 'struct'),
            ('10:21-10:24', 'NAME', 'Core'),
            ('11:5-11:5', 'LCB', None),
            ('12:9-12:16', 'KEYW', 'repeated'),
            ('12:18-12:21', 'KEYW', 'enum'),
            ('12:23-12:27', 'NAME', 'Types'),
            ('13:9-13:9', 'LCB', None),
            ('14:13-14:14', 'NAME', 'T1'),
            ('14:16-14:16', 'ASSIGN', None),
            ('14:18-14:18', 'NUMBER', 1),
            ('14:19-14:19', 'COMMA', None),
            ('15:13-15:14', 'NAME', 'T2'),
            ('15:16-15:16', 'ASSIGN', None),
            ('15:18-15:18', 'NUMBER', 2),
            ('16:9-16:9', 'RCB', None),
            ('16:10-16:10', 'SEMI', None),
            ('21:9-21:16', 'KEYW', 'repeated'),
            ('21:18-21:23', 'KEYW', 'struct'),
            ('21:25-21:31', 'NAME', 'Numbers'),
            ('22:9-22:9', 'LCB', None),
            ('23:13-23:15', 'KEYW', 'int'),
            ('23:17-23:17', 'NAME', 'x'),
            ('23:18-23:18', 'SEMI', None),
            ('24:13-24:15', 'KEYW', 'int'),
            ('24:17-24:17', 'NAME', 'y'),
            ('24:18-24:18', 'SEMI', None),
            ('25:9-25:9', 'RCB', None),
            ('25:10-25:10', 'SEMI', None),
            ('27:9-27:11', 'KEYW', 'int'),
            ('27:13-27:13', 'NAME', 'a'),
            ('27:14-27:14', 'SEMI', None),
            ('28:9-28:11', 'KEYW', 'int'),
            ('28:13-28:13', 'NAME', 'b'),
            ('28:14-28:14', 'SEMI', None),
            ('29:5-29:5', 'RCB', None),
            ('29:6-29:6', 'SEMI', None),
            ('31:5-31:7', 'KEYW', 'int'),
            ('31:9-31:9', 'NAME', 'x'),
            ('31:10-31:10', 'SEMI', None),
            ('32:5-32:7', 'KEYW', 'int'),
            ('32:9-32:9', 'NAME', 'y'),
            ('32:10-32:10', 'SEMI', None),
            ('33:1-33:1', 'RCB', None),
            ('33:2-33:2', 'SEMI', None),
            (None, 'END', None)
        ]

    def hardskip_test_performance(self):
        print timeit.timeit("tokens('longexample.meta')", "from %s import tokens" % __name__, number=1)

if __name__ == '__main__':
    tokens('longexample.meta')
